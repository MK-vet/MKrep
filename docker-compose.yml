version: '3.8'

services:
  mkrep:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-analysis
    volumes:
      # Mount local data directory to container
      - ./data:/app/data
      # Mount local output directory to container
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
      - MKREP_DATA_DIR=/app/data
      - MKREP_OUTPUT_DIR=/app/output
    command: mkrep --help
    
  # Service for cluster analysis
  mkrep-cluster:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-cluster-analysis
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: python src/cluster_mic_amr_virulence.py
    
  # Service for MDR analysis
  mkrep-mdr:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-mdr-analysis
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: python src/mdr_analysis.py
    
  # Service for network analysis
  mkrep-network:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-network-analysis
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: python src/network_analysis.py
    
  # Service for phylogenetic analysis
  mkrep-phylo:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-phylo-analysis
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: python src/phylogenetic_clustering.py
    
  # Service for Streptococcus suis analysis
  mkrep-strepsuis:
    build:
      context: .
      dockerfile: Dockerfile
    image: mkrep:latest
    container_name: mkrep-strepsuis-analysis
    volumes:
      - ./data:/app/data
      - ./output:/app/output
    environment:
      - PYTHONUNBUFFERED=1
      - PYTHONPATH=/app
    command: python src/strep_suis_phylo_cluster.py

# Usage:
# Build all services: docker-compose build
# Run default service: docker-compose up mkrep
# Run cluster analysis: docker-compose up mkrep-cluster
# Run MDR analysis: docker-compose up mkrep-mdr
# Run network analysis: docker-compose up mkrep-network
# Run phylogenetic analysis: docker-compose up mkrep-phylo
# Run strepsuis analysis: docker-compose up mkrep-strepsuis
# Run in detached mode: docker-compose up -d mkrep-cluster
# View logs: docker-compose logs mkrep-cluster
# Stop services: docker-compose down
# Clean up: docker-compose down -v

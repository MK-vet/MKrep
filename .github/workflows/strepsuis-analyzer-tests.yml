name: StrepSuis Analyzer Tests

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'separated_repos/strepsuis-analyzer/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'separated_repos/strepsuis-analyzer/**'
  workflow_dispatch:

# Limit permissions for security
permissions:
  contents: read

jobs:
  test:
    name: Test StrepSuis Analyzer
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.8', '3.9', '3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'
    
    - name: Display Python version
      run: |
        python --version
        pip --version
    
    - name: Install dependencies
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock
    
    - name: Run unit tests
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pytest tests/ -v -m unit --tb=short --no-cov
    
    - name: Run integration tests
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pytest tests/ -v -m integration --tb=short --no-cov
    
    - name: Run statistical validation tests
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pytest tests/test_statistical_functions.py -v -m statistical --tb=short --no-cov
    
    - name: Run all tests with coverage
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pytest tests/ -v --cov=. --cov-report=term-missing --cov-report=xml --cov-report=html
    
    - name: Upload coverage reports
      if: matrix.python-version == '3.11'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-reports
        path: separated_repos/strepsuis-analyzer/htmlcov/
    
    - name: Check coverage thresholds
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pip install coverage
        coverage report --fail-under=80
    
    - name: Verify app.py syntax
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -m py_compile app.py
        echo "✓ app.py syntax is valid"
    
    - name: Test data file loading
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -c "
        from pathlib import Path
        import pandas as pd
        
        data_dir = Path('data')
        required_files = ['AMR_genes.csv', 'MIC.csv', 'Virulence.csv', 'MLST.csv', 'Serotype.csv', 'Snp_tree.newick']
        
        for file in required_files:
            file_path = data_dir / file
            assert file_path.exists(), f'{file} not found'
            print(f'✓ {file} exists')
        
        # Test loading CSV files
        for csv_file in ['AMR_genes.csv', 'MIC.csv', 'Virulence.csv', 'MLST.csv', 'Serotype.csv']:
            df = pd.read_csv(data_dir / csv_file)
            assert len(df) > 0, f'{csv_file} is empty'
            print(f'✓ {csv_file} loaded successfully ({len(df)} rows)')
        
        print('All data files verified!')
        "
    
    - name: Test mathematical functions
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -c "
        import numpy as np
        from app import (
            calculate_shannon_diversity,
            calculate_simpson_diversity,
            calculate_jaccard_distance,
            calculate_hamming_distance
        )
        
        # Test with known values
        data = np.array([[1, 0, 1, 0], [0, 1, 0, 1]])
        
        shannon = calculate_shannon_diversity(data)
        simpson = calculate_simpson_diversity(data)
        
        assert shannon >= 0, 'Shannon index should be non-negative'
        assert isinstance(simpson, float), 'Simpson index should be float'
        
        # Test distances
        x = np.array([1, 0, 1, 0])
        y = np.array([1, 0, 1, 0])
        
        jaccard = calculate_jaccard_distance(x, y)
        hamming = calculate_hamming_distance(x, y)
        
        assert jaccard == 0.0, 'Jaccard distance of identical vectors should be 0'
        assert hamming == 0.0, 'Hamming distance of identical vectors should be 0'
        
        print('✓ All mathematical functions validated')
        "
  
  coverage-report:
    name: Generate Coverage Report
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock coverage
    
    - name: Generate coverage report
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        pytest tests/ --cov=. --cov-report=term --cov-report=html --cov-report=json
    
    - name: Display coverage summary
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        echo "=== Coverage Summary ==="
        coverage report --precision=2
        echo ""
        echo "=== Statistical Functions Coverage ==="
        coverage report --include="app.py" --precision=2
    
    - name: Check mathematical function coverage
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -c "
        import json
        with open('coverage.json') as f:
            cov_data = json.load(f)
        
        # Get coverage for app.py (contains all mathematical functions)
        app_coverage = cov_data.get('totals', {}).get('percent_covered', 0)
        
        print(f'Total coverage: {app_coverage:.2f}%')
        
        if app_coverage < 80:
            print(f'WARNING: Coverage {app_coverage:.2f}% is below 80% target')
        else:
            print(f'✓ Coverage target met: {app_coverage:.2f}% >= 80%')
        "
  
  integration-smoke-test:
    name: Integration Smoke Test
    needs: test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Test import all modules
      working-directory: separated_repos/strepsuis-analyzer
      run: |
        python -c "
        from app import (
            load_data,
            load_phylogenetic_tree,
            calculate_shannon_diversity,
            calculate_simpson_diversity,
            calculate_jaccard_distance,
            calculate_hamming_distance,
            calculate_pairwise_distances,
            calculate_prevalence,
            calculate_correlation_matrix,
            plot_prevalence_bar,
            plot_heatmap,
            plot_distance_heatmap,
            plot_distribution,
            plot_pie_chart
        )
        print('✓ All modules imported successfully')
        "
    
    - name: Summary
      run: |
        echo "=== StrepSuis Analyzer CI Summary ==="
        echo "✓ All tests passed"
        echo "✓ Coverage requirements met"
        echo "✓ Integration tests successful"
        echo "✓ Ready for deployment"
